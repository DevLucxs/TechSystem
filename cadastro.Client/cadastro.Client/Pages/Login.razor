@page "/"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject cadastro.Client.Services.SessaoService Sessao
@layout Shared.PublicLayout
@using cadastro.Client.Models

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TechSystem - Login</title>
    <link href="css/login.css" rel="stylesheet">
</head>

<body>
    <div class="page">
        <div class="left">
            <img src="assets/_163d66ba-473a-40af.png" alt="TECHSYSTEM" class="logo-techsystem" />
        </div>

        <div class="right">
            <div class="login-card">
                <img src="assets/symbol.png" alt="TECHSYSTEM" class="card-icon" />

                <input class="field" type="email" placeholder="Email" @bind="usuario.Email" />
                <input class="field" type="password" placeholder="Senha" @bind="usuario.Senha" />

                <div class="btn-group">
                    <button class="btn-login" @onclick="FazerLogin">Login</button>
                    <button class="btn-outline" @onclick="TelaCadastro">Criar Conta</button>
                </div>

                <a class="forgot" href="#">Esqueceu Senha?</a>
            </div>
        </div>

    </div>
</body>

@if (!string.IsNullOrEmpty(mensagem))
{
    <div class="alert @classeMensagem">@mensagem</div>
}

@code {
    Usuario usuario = new Usuario();
    string mensagem = string.Empty;
    string classeMensagem = "alert-info";

    void TelaCadastro() => Navigation.NavigateTo("/cadastro");

    async Task FazerLogin()
    {
        var loginRequest = new { Email = usuario.Email, Senha = usuario.Senha };
        var response = await Http.PostAsJsonAsync("https://localhost:7002/api/usuarios/login", loginRequest);

        if (response.IsSuccessStatusCode)
        {
            var dados = await response.Content.ReadFromJsonAsync<LoginResponse>();

            // guarda na sessão
            Sessao.DefinirSessao(dados.Id, dados.Nome, dados.Role);

            mensagem = $"Bem-vindo {dados.Nome} ({dados.Role})";
            classeMensagem = "alert-success";

            // redireciona conforme perfil
            Navigation.NavigateTo(dados.Role == "Admin" ? "/inicial" : "/usuario");
        }
        else
        {
            mensagem = "Email ou senha inválidos.";
            classeMensagem = "alert-danger";
        }
    }


    public class LoginResponse
    {
        public int Id { get; set; }          // 🔑 novo campo
        public string Nome { get; set; } = "";
        public string Email { get; set; } = "";
        public string Role { get; set; } = "";
    }

}
